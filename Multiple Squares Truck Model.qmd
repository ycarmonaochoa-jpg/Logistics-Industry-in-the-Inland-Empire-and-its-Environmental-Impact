---
title: "Final Truck Model"
format: html
editor: visual
---

## 

```{r}
library(deSolve)
library(tidyverse)
```

To run this document, run Parameter Estimation.qmd first.

Change the number of regions by changing N and then changing the number of variables to account for those regions. C should always be NxN, and all of the other parameter vectors should be N long. Initial conditions should be NxV where V is the number of variables being modeled.

Constants

```{r}
#constants for the type of simulation we run

set.seed(46)
#number of regions
N <- 4

#height of air above the Inland Empire that is susceptible to pollution (m)
H <- 1500

#volume of each region (m^3)
V <- 7*10^10 * H / N

#warehouse growth mean from logistic fit
warehouse_rate_yrs <- 0.0536353459944 #(yr^-1)
warehouse_rate <- warehouse_rate_yrs * 0.00273973 #(day^-1)

#warehouse carrying capacity from logistic fit
warehouse_cap <- 1.1193946263*10^9 #sqft

#mean number of trucks and warehouses at start of data
trucks_0 <- 300000 #Trucks per region
warehouses_0 <- sqft_yearly$logistic_pred[1] #sqft in total IE

#what year should we start showing our data at?
start_year <- 2020
end_year <- 2080
```

System of ODEs itself:

```{r}
#Parameters
parameters <- list(
  a = c(0.8, 0.2, 0.05, 0.05), #trucks going to park, should add to 1 since most trucks have a 11 hour daily limit
  b = rnorm(N, mean = warehouse_summary$b[1], sd = 0.00001), #(trucks/day/sqft of warehouse)
  #trucks starting their journeys, a random number with the mean being the average amount of trips per day that a square foot of warehosue produces in Southern CA.

  C = matrix(c(0, 0.2, 0, 0,
               0.2, 0, 0.2, 0.2,
               0, 0.2, 0, 0,
               0, 0.2, 0, 0), 
             ncol = N), #Truck travel matrix, fraction of trucks moving between the regions
  #Change ^ these values to change the number of trucks traveling between each region.
            
  
  w1 = rnorm(N, warehouse_rate, sd = 0.00001), #warehouse growth rate
  w2 = rnorm(N, warehouse_cap, sd = 0.1*10^9) / N, #warehouse carrying capacity
  
  pm = vehicle_summary$PM[1] * 10^6 / V, #trucks diesel PM emissions rate (micrograms/(truck*m^3*day))
  pm_disp = 0.5, #PM dispersal rate, 50% of PM in the air disperses every day
  
  co2 = vehicle_summary$CO2[1], #trucks CO2 emissions rate (g/truck/day)
  
  nox = vehicle_summary$NOx[1] * 10^6 / V / 1.4, #trucks NOx emissions rate (ppb/truck/day)
  nox_disp = 0.9 #NOx dispersal rate
  )

#Initial Conditions
Y <- c(
  rnorm(N, trucks_0, 100000), #initial trucks
  rnorm(N, warehouses_0, 100000000) / N, #initial warehouses
  8, 8, 8, 8, #initial PM in the air (micrograms/m^3)
  0, 0, 0, 0, #initial CO2 in the air (g)
  0, 0, 0, 0 #initial NOx in the air()
)


#Growth function
truck_growth <- function(t, Y, parameters) {
dY <- c()
 with(as.list(c(Y, parameters)),{
 # rate of change
   #Y[i] is trucks,
   #Y[i + N] is warehouses
   #Y[i + 2N] is PM
   #Y[i + 3N] is CO2
   #Y[i + 4N] is NOx
      for (i in 1:N){
        dY[i] <- parameters$b[i] * Y[i + N] -  
          parameters$a[i] * Y[i] - 
          sum(parameters$C[,i]) * Y[i] +
          sum(parameters$C[i,] * Y[1:N]) #trucks
        
        dY[i + N] <- parameters$w1[i] * Y[i + N] * 
          (1 - (1 / parameters$w2[i]) * 
             Y[i + N]) #warehouses
        
        dY[i + 2*N] <- parameters$pm * Y[i] - parameters$pm_disp * Y[i + 2*N] #PM
        
        dY[i + 3*N] <- parameters$co2 * Y[i] #CO2
        
        dY[i + 4*N] <- parameters$nox * Y[i] - parameters$nox_disp * Y[i + 4*N] #NOx
      }
    # return the rate of change
    list(dY)
 })
}

#time step and how long to run ODE
total_days <- (end_year - 1980) * 365.25
time_step <- 0.1 #sample it every 0.1 days
max_time <- total_days #run for this many days
times <- seq(0, max_time, by = time_step)

#Run
truck_growth_results <- ode(y = Y, times = times, func = truck_growth, parms = parameters) |>
  as_tibble() 
```

Data wrangling

```{r}
limit <- (start_year - 1980) * 365.25

trucks <- truck_growth_results |>
  select(1:(N + 1)) |>
  mutate(total_trucks = rowSums(across(2:(N + 1)))) |>
  filter(time > limit) |>
  mutate(time = time - limit)

trucks_few_days <- truck_growth_results |>
  select(1:(N + 1)) |>
  mutate(total_trucks = rowSums(across(2:(N + 1)))) |>
  filter(time < 50) 

warehouses <- truck_growth_results |>
  select(1, (N + 2):(2*N + 1)) |>
  mutate(total_warehouses = rowSums(across(2:(N + 1)))) |>
  filter(time > limit) |>
  mutate(time = time - limit)

PM <- truck_growth_results |>
  select(1, (2*N + 2):(3*N + 1)) |>
  mutate(total_PM = rowMeans(across(2:(N + 1))))|>
  filter(time > limit - 20*365.25) |>
  mutate(time = time - limit + 20*365.25)

CO2 <- truck_growth_results |>
  select(1, (3*N + 2):(4*N + 1)) |>
  mutate(total_CO2 = rowSums(across(2:(N + 1)))) #|>
  #filter(time > limit) |>
  #mutate(time = time - limit)

NOx <- truck_growth_results |>
  select(1, (4*N + 2):(5*N + 1)) |>
  mutate(total_NOx = rowMeans(across(2:(N + 1)))) |>
  filter(time > limit - 20*365.25) |>
  mutate(time = time - limit + 20*365.25)
```

Plotting:

Trucks

```{r}
#R vs time graph
trucks |>
ggplot() +
  geom_line(aes(x = time, y = total_trucks)) +
  theme_classic() +
  labs(
    title = "Total Trucks vs Time",
    subtitle = str_c("Starting in ", start_year, ", ending in ", end_year),
    x = "Time (days)",
    y = "Total Trucks"
  )

```

```{r}
trucks |>
  pivot_longer(2:(N + 1), names_to = "region", values_to = "trucks") |>
  select(time, region, trucks, total_trucks) |>
  ggplot(aes(x = time)) +
  geom_line(aes(y = trucks, color = region)) +
  geom_line(aes(y = total_trucks, color = "Total")) +
  theme_classic() +
  labs(
    title = "Trucks vs Time by Region",
    subtitle = str_c("Starting in ", start_year, ", ending in ", end_year),
    x = "Time (days)",
    y = "Trucks",
    legend = "Region"
  )
```

```{r}
trucks_few_days |>
  pivot_longer(2:(N + 1), names_to = "region", values_to = "trucks") |>
  select(time, region, trucks, total_trucks) |>
  ggplot(aes(x = time)) +
  geom_line(aes(y = trucks, color = region)) +
  geom_line(aes(y = total_trucks, color = "Total")) +
  theme_classic() +
  labs(
    title = "Trucks vs Time by Region",
    subtitle = "Short time scale",
    x = "Time (days)",
    y = "Trucks",
    legend = "Region"
  )
```

Warehouses

```{r}
#W vs time graph
warehouses |>
ggplot(aes(x = time, y = total_warehouses)) +
  geom_line() +
  theme_classic() +
  labs(
    title = "Total Warehouses vs Time",
    subtitle = str_c("Starting in ", start_year, ", ending in ", end_year),
    x = "Time (days)",
    y = "Total Warehouses Area (sq. ft)"
  )

```

```{r}
warehouses |>
  rename_with(~as.character(seq_along(.x)), .cols = 2:(N + 1)) |>
  pivot_longer(2:(N + 1), names_to = "region", values_to = "warehouses") |>
  select(time, region, warehouses, total_warehouses) |>
  ggplot(aes(x = time)) +
  geom_line(aes(y = warehouses, color = region)) +
  theme_classic() +
  labs(
    title = "Warehouse Area vs Time by Region",
    subtitle = str_c("Starting in ", start_year, ", ending in ", end_year),
    x = "Time (days)",
    y = "Warehouse Area (sq. ft)",
    legend = "Region"
  )
```

Particulate Matter

```{r}
#PM vs time graph
PM |>
ggplot(aes(x = time, y = total_PM)) +
  geom_line() +
  theme_classic() +
  labs(
    title = "Particulate Matter (PM) Concentration vs Time",
    subtitle = str_c("Starting in ", start_year - 20, ", ending in ", end_year),
    x = "Time (days)",
    y = "Total PM (μg/m^3)"
  )
```

```{r}
PM |>
  rename_with(~as.character(seq_along(.x)), .cols = 2:(N + 1)) |>
  pivot_longer(2:(N + 1), names_to = "region", values_to = "PM") |>
  select(time, region, PM, total_PM) |>
  ggplot(aes(x = time)) +
  geom_line(aes(y = PM, color = region)) +
  geom_line(aes(y = total_PM, color = "Total")) +
  theme_classic() +
  labs(
    title = "Particulate Matter (PM) Concentrations vs Time By Region",
    subtitle = str_c("Starting in ", start_year - 20, ", ending in ", end_year),
    x = "Time (days)",
    y = "Total PM (μg/m^3)",
    legend = "Region"
  )
```

Carbon Dioxide

```{r}
#CO2 vs time graph
CO2 |>
ggplot(aes(x = time, y = total_CO2)) +
  geom_line() +
  theme_classic() +
  labs(
    title = "Total CO2 Emitted since 1980 vs Time",
    subtitle = str_c("Starting in 1980, ending in ", end_year),
    x = "Time (days)",
    y = "Total CO2 (g)"
  )
```

Nitrogen Oxides

```{r}
NOx |>
ggplot(aes(x = time, y = total_NOx)) +
  geom_line() +
  theme_classic() +
  labs(
    title = "Nitrogen Oxide (NOx) Concentration vs Time",
    subtitle = str_c("Starting in ", start_year,", ending in ", end_year),
    x = "Time (days)",
    y = "Total NOx (ppb)"
  )
```

```{r}
NOx |>
  rename_with(~as.character(seq_along(.x)), .cols = 2:(N + 1)) |>
  pivot_longer(2:(N + 1), names_to = "region", values_to = "NOx") |>
  select(time, region, NOx, total_NOx) |>
  ggplot(aes(x = time)) +
  geom_line(aes(y = NOx, color = region)) +
  geom_line(aes(y = total_NOx, color = "Total")) +
  theme_classic() +
  labs(
    title = "Nitrogen Oxide (NOx) Concentrations vs Time By Region",
    subtitle = str_c("Starting in ", start_year, ", ending in ", end_year),
    x = "Time (days)",
    y = "Total NOx (ppb)",
    legend = "Region"
  )
```
